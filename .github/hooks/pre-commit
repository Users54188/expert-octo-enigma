#!/bin/bash
# Pre-commit hook for CloudQuantBot
# Performs local checks before committing

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

# Get the project root directory
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

log_info "Running pre-commit checks..."

# 1. Check formatting
log_info "Checking code format..."
UNFORMATTED=$(gofmt -l .)
if [ -n "$UNFORMATTED" ]; then
    log_error "The following files need formatting:"
    echo "$UNFORMATTED"
    log_info "Run 'gofmt -w .' to fix formatting issues"
    exit 1
fi
log_info "Code format check passed"

# 2. Run go vet
log_info "Running go vet..."
if ! go vet ./...; then
    log_error "go vet failed"
    exit 1
fi
log_info "go vet passed"

# 3. Run go mod tidy
log_info "Running go mod tidy..."
go mod tidy
if [ -n "$(git diff go.mod go.sum)" ]; then
    log_warn "go.mod or go.sum was modified by go mod tidy"
    git add go.mod go.sum
fi

# 4. Run quick tests
log_info "Running quick tests..."
if ! go test -short ./...; then
    log_error "Quick tests failed"
    exit 1
fi
log_info "Quick tests passed"

# 5. Check for TODO/FIXME comments (warning only)
TODO_COUNT=$(git diff --cached --name-only | xargs grep -i "TODO\|FIXME" | wc -l || true)
if [ "$TODO_COUNT" -gt 0 ]; then
    log_warn "Found $TODO_COUNT TODO/FIXME comments in staged files"
fi

# 6. Check file size
log_info "Checking file sizes..."
MAX_FILE_SIZE=1048576 # 1MB
LARGE_FILES=$(git diff --cached --name-only --diff-filter=d | while read file; do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt "$MAX_FILE_SIZE" ]; then
            echo "$file ($((size/1024))KB)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    log_warn "Found large files in staging area:"
    echo "$LARGE_FILES"
fi

# 7. Check for secrets
log_info "Checking for secrets..."
SECRET_PATTERNS=(
    "password.*=.*['\"][^'\"]+['\"]"
    "api_key.*=.*['\"][^'\"]+['\"]"
    "secret.*=.*['\"][^'\"]+['\"]"
    "token.*=.*['\"][^'\"]+['\"]"
    "aws_access_key_id"
    "aws_secret_access_key"
)

STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)
FOUND_SECRETS=false

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -iE "$pattern" "$file" > /dev/null 2>&1; then
                log_error "Potential secret found in $file"
                FOUND_SECRETS=true
            fi
        done
    fi
done

if [ "$FOUND_SECRETS" = true ]; then
    log_error "Please remove secrets before committing"
    exit 1
fi
log_info "Secret check passed"

# 8. Check for binary files
log_info "Checking for binary files..."
BINARY_FILES=$(git diff --cached --name-only --diff-filter=d | while read file; do
    if [ -f "$file" ]; then
        if file --mime "$file" | grep -q "charset=binary"; then
            echo "$file"
        fi
    fi
done)

if [ -n "$BINARY_FILES" ]; then
    log_warn "Binary files detected in staging area:"
    echo "$BINARY_FILES"
    log_warn "Make sure you intend to commit binary files"
fi

log_info "All pre-commit checks passed!"
exit 0
